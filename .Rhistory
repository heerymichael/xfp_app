TRUE ~ team
),
# Add calculated fields
xFP = as.numeric(xFP),
actual_FP = as.numeric(actual_FP),
fp_diff = actual_FP - xFP,
games = 1
) %>%
arrange(team, week, desc(xFP))
cat("✓ Combined xFP data processed.\n")
cat("  - Total rows:", nrow(combined_xfp_data), "\n")
cat("  - Unique players:", n_distinct(combined_xfp_data$player), "\n")
cat("  - Weeks included:", paste(sort(unique(combined_xfp_data$week)), collapse = ", "), "\n\n")
# Upload to public Google Sheet ====
cat("Step 3: Uploading processed data to public Google Sheet...\n")
# Clear existing sheet and write new data
sheet_write(
combined_xfp_data,
ss = target_sheet_url,
sheet = "combined_xfp_data"
)
cat("✓ Data successfully uploaded to Google Sheet.\n\n")
# Optional: Save local backup
cat("Step 4: Saving local backup...\n")
dir.create("data", showWarnings = FALSE)
write_csv(combined_xfp_data, "data/combined_xfp_data_backup.csv")
cat("✓ Local backup saved to data/combined_xfp_data_backup.csv\n\n")
# Summary
cat("====================================\n")
cat("UPDATE COMPLETE!\n")
cat("====================================\n")
cat("Processed", nrow(combined_xfp_data), "rows of data\n")
cat("Data is now available at:\n")
cat(target_sheet_url, "\n\n")
cat("Your Shiny app will automatically use this updated data.\n")
cat("No need to redeploy the app!\n")
shiny::runApp()
runApp()
library(tidyverse)
library(janitor)
#' Prepare xFP data from source files
#' @return List containing combined_xfp_data and all_players_xfp
prepare_xfp_data_from_source <- function() {
# Check if source files exist
wr_te_file <- "data/NFL Weekly Volume - WeeklyAirYards.csv"
rb_file <- "data/NFL Weekly Volume - WeeklyRBXP.csv"
if (!file.exists(wr_te_file) || !file.exists(rb_file)) {
stop("Source data files not found. Please ensure both files exist:
- data/NFL Weekly Volume - WeeklyAirYards.csv
- data/NFL Weekly Volume - WeeklyRBXP.csv")
}
# Process WR/TE data
wr_te_xfp <- read_csv(wr_te_file, show_col_types = FALSE) %>%
select(receiver, position, team, week, season, knn_fps) %>%
rename(player = receiver) %>%
filter(position != "RB")
# Process RB data - Note the capital T in Team
rb_xfp <- read_csv(rb_file, show_col_types = FALSE) %>%
rename(team = Team) %>%  # Rename Team to team for consistency
select(player, week, season, team, knn_fps) %>%
mutate(position = "RB")
# Combine all players
all_players_xfp <- bind_rows(wr_te_xfp, rb_xfp) %>%
# Standardize team names
mutate(
team = case_when(
team == "LA" ~ "LAR",
team == "STL" ~ "LAR",
team == "SD" ~ "LAC",
team == "OAK" ~ "LV",
TRUE ~ team
)
)
# Save processed file for future use
write_csv(all_players_xfp, "data/all_players_xfp.csv")
# Create combined xFP data for the main analysis
combined_xfp_data <- create_combined_xfp_dataset()
return(list(
combined_xfp_data = combined_xfp_data,
all_players_xfp = all_players_xfp
))
}
#' Create combined xFP dataset with actual points
#' @return Data frame with combined xFP and actual points
create_combined_xfp_dataset <- function() {
# Read source files
air_yards_data <- read_csv("data/NFL Weekly Volume - WeeklyAirYards.csv",
show_col_types = FALSE)
rb_data <- read_csv("data/NFL Weekly Volume - WeeklyRBXP.csv",
show_col_types = FALSE)
# Process WR/TE/QB data (exclude RBs to avoid double counting)
wr_te_qb_data <- air_yards_data %>%
filter(position != "RB") %>%
mutate(
player = receiver,
xFP = ifelse(!is.na(knn_fps), knn_fps, 0),
actual_FP = ppr_points,
# Add rushing columns as 0 for WR/TE
carries = 0,
rush_yards = 0,
rush_touchdowns = 0,
goal_line_carry = 0
) %>%
select(
player, position, team, week, season, receiver_id,
xFP, actual_FP,
# Receiving stats
target, air_yards, rz_target, receptions,
receiving_yards, receiving_touchdowns,
# Rushing stats (all 0 for WR/TE)
carries, rush_yards, rush_touchdowns, goal_line_carry,
# Other useful fields
adot, catch_rate, ypt
)
# Process RB data - handling the capital T in Team
rb_combined_data <- rb_data %>%
rename(team = Team) %>%  # Fix the capital T
mutate(
player = player,
position = "RB",
xFP = knn_fps,  # Already total (rushing + receiving)
actual_FP = actual_fps,  # Already total
# Map the existing columns correctly
target = targets,
rz_target = NA_real_,
receptions = NA_real_,
receiving_yards = NA_real_,
receiving_touchdowns = NA_real_,
receiver_id = paste0(player, "-", team),
adot = NA_real_,
catch_rate = NA_real_,
ypt = NA_real_
) %>%
select(
player, position, team, week, season, receiver_id,
xFP, actual_FP,
# Receiving stats
target, air_yards, rz_target, receptions,
receiving_yards, receiving_touchdowns,
# Rushing stats
carries, rush_yards, rush_touchdowns, goal_line_carry,
# Other fields
adot, catch_rate, ypt
)
# Combine the datasets
combined_data <- bind_rows(wr_te_qb_data, rb_combined_data) %>%
# Standardize team names
mutate(
team = case_when(
team == "LA" ~ "LAR",
team == "STL" ~ "LAR",
team == "SD" ~ "LAC",
team == "OAK" ~ "LV",
TRUE ~ team
)
) %>%
arrange(team, week, desc(xFP))
# Add calculated fields
combined_data <- combined_data %>%
mutate(
xFP = as.numeric(xFP),
actual_FP = as.numeric(actual_FP),
fp_diff = actual_FP - xFP,
games = 1
)
# Save for future use
write_csv(combined_data, "data/combined_xfp_data.csv")
return(combined_data)
}
#' Force regenerate all data files
#' Use this when source data changes
force_regenerate_data <- function() {
# Delete existing processed files
if (file.exists("data/combined_xfp_data.csv")) {
unlink("data/combined_xfp_data.csv")
cat("Deleted existing combined_xfp_data.csv\n")
}
if (file.exists("data/all_players_xfp.csv")) {
unlink("data/all_players_xfp.csv")
cat("Deleted existing all_players_xfp.csv\n")
}
# Regenerate
cat("Regenerating data files...\n")
prepare_xfp_data_from_source()
cat("Data regeneration complete!\n")
}
library(dplyr)
library(tidyr)
# Standardize team names (fix LA -> LAR issue)
standardize_team_names <- function(team) {
case_when(
team == "LA" ~ "LAR",
team == "STL" ~ "LAR",
team == "SD" ~ "LAC",
team == "OAK" ~ "LV",
TRUE ~ team
)
}
# Process xFP data
process_xfp_data <- function(data) {
if (is.null(data) || nrow(data) == 0) return(data)
data %>%
mutate(
team = standardize_team_names(team),
xFP = as.numeric(xFP),
actual_FP = as.numeric(actual_FP),
fp_diff = actual_FP - xFP
)
}
# Get team name mapping
get_team_name_mapping <- function() {
data.frame(
team_abbr = c("ARI", "ATL", "BAL", "BUF", "CAR", "CHI", "CIN", "CLE",
"DAL", "DEN", "DET", "GB", "HOU", "IND", "JAX", "KC",
"LAC", "LAR", "LV", "MIA", "MIN", "NE", "NO", "NYG",
"NYJ", "PHI", "PIT", "SEA", "SF", "TB", "TEN", "WAS"),
team_name = c("ARIZONA CARDINALS", "ATLANTA FALCONS", "BALTIMORE RAVENS",
"BUFFALO BILLS", "CAROLINA PANTHERS", "CHICAGO BEARS",
"CINCINNATI BENGALS", "CLEVELAND BROWNS", "DALLAS COWBOYS",
"DENVER BRONCOS", "DETROIT LIONS", "GREEN BAY PACKERS",
"HOUSTON TEXANS", "INDIANAPOLIS COLTS", "JACKSONVILLE JAGUARS",
"KANSAS CITY CHIEFS", "LOS ANGELES CHARGERS", "LOS ANGELES RAMS",
"LAS VEGAS RAIDERS", "MIAMI DOLPHINS", "MINNESOTA VIKINGS",
"NEW ENGLAND PATRIOTS", "NEW ORLEANS SAINTS", "NEW YORK GIANTS",
"NEW YORK JETS", "PHILADELPHIA EAGLES", "PITTSBURGH STEELERS",
"SEATTLE SEAHAWKS", "SAN FRANCISCO 49ERS", "TAMPA BAY BUCCANEERS",
"TENNESSEE TITANS", "WASHINGTON COMMANDERS"),
stringsAsFactors = FALSE
)
}
# Prepare data for Top Performers table
prepare_top_performers_data <- function(data, position, weeks, min_games, num_players,
rookies_only = FALSE, rookie_list = NULL) {
if (is.null(data) || nrow(data) == 0) return(data.frame())
if (is.null(num_players) || is.na(num_players) || !is.numeric(num_players)) {
num_players <- 12
}
num_players <- as.integer(num_players)
if (num_players < 1) num_players <- 12
team_names <- get_team_name_mapping()
# Filter by position only if not "ALL"
filtered_data <- data %>%
filter(week %in% !!weeks)
if (position != "ALL") {
filtered_data <- filtered_data %>%
filter(position == !!position)
}
# Apply rookies filter if enabled
if (rookies_only && !is.null(rookie_list)) {
filtered_data <- filtered_data %>%
filter(player %in% rookie_list)
}
filtered_data %>%
group_by(player, position, team) %>%
summarise(
games_played = n_distinct(week),
weeks_played_list = list(sort(unique(week))),
total_expected = sum(xFP, na.rm = TRUE),
total_actual = sum(actual_FP, na.rm = TRUE),
expected_points = mean(xFP, na.rm = TRUE),
actual_points = mean(actual_FP, na.rm = TRUE),
receiver_id = first(receiver_id),
.groups = "drop"
) %>%
left_join(team_names, by = c("team" = "team_abbr")) %>%
mutate(
expected_points = coalesce(expected_points, 0),
actual_points = coalesce(actual_points, 0),
team_name = coalesce(team_name, paste(team, "TEAM"))
) %>%
filter(
games_played >= !!min_games,
expected_points > 0
) %>%
arrange(desc(expected_points)) %>%
slice_head(n = num_players)
}
# Prepare data for Team Summaries
prepare_team_summary_data <- function(data, team, position, weeks, min_games) {
if (is.null(data) || nrow(data) == 0) return(data.frame())
filtered_data <- data %>%
filter(week %in% !!weeks)
if (team != "" && team != "ALL") {
filtered_data <- filtered_data %>%
filter(team == !!team)
}
if (position != "ALL") {
filtered_data <- filtered_data %>%
filter(position == !!position)
}
filtered_data %>%
group_by(player, position) %>%
summarise(
games_played = n_distinct(week),
total_expected = sum(xFP, na.rm = TRUE),
total_actual = sum(actual_FP, na.rm = TRUE),
avg_expected = mean(xFP, na.rm = TRUE),
avg_actual = mean(actual_FP, na.rm = TRUE),
.groups = "drop"
) %>%
filter(games_played >= !!min_games) %>%
arrange(desc(avg_expected))
}
# Get team players for Team Detail
get_team_players <- function(data, team, min_games = 3) {
if (is.null(data) || nrow(data) == 0 || length(team) == 0) {
return(data.frame())
}
data %>%
filter(team == !!team) %>%
group_by(player, position) %>%
summarise(
avg_xfp = mean(xFP, na.rm = TRUE),
games = n(),
.groups = "drop"
) %>%
filter(games >= !!min_games) %>%
arrange(desc(avg_xfp))
}
# Prepare data for Team Detail facet plot
prepare_team_facet_data <- function(data, team, included_players, min_games = 3) {
if (is.null(data) || nrow(data) == 0 || length(team) == 0) {
return(NULL)
}
team_data <- data %>%
filter(
team == !!team,
player %in% !!included_players
)
if (nrow(team_data) == 0) {
return(NULL)
}
player_order <- team_data %>%
group_by(player, position) %>%
summarise(
avg_xfp = mean(xFP, na.rm = TRUE),
games_played = n(),
.groups = "drop"
) %>%
filter(games_played >= !!min_games) %>%
arrange(desc(avg_xfp)) %>%
pull(player)
team_data %>%
filter(player %in% player_order) %>%
mutate(player = factor(player, levels = player_order))
}
# Get position color
get_position_color <- function(position) {
switch(position,
"QB" = "#E91E63",
"RB" = "#2196F3",
"WR" = "#4CAF50",
"TE" = "#FF9800",
"#999999"
)
}
# Calculate week range text
get_week_range_text <- function(selected_weeks, all_weeks) {
if (length(selected_weeks) == 0) {
"no weeks selected"
} else if (length(selected_weeks) == 1) {
paste0("Week ", selected_weeks[1])
} else if (length(selected_weeks) == length(all_weeks) &&
all(selected_weeks == all_weeks)) {
"the entire 2025 season"
} else if (length(selected_weeks) == 4 &&
all(selected_weeks == tail(all_weeks, 4))) {
"the last four weeks"
} else {
paste0("Weeks ", paste(selected_weeks, collapse = ", "))
}
}
# Format subtitle text for tables
format_table_subtitle <- function(position, selected_weeks, all_weeks) {
pos_name <- switch(position,
"RB" = "running backs",
"WR" = "wide receivers",
"TE" = "tight ends",
"ALL" = "all positions"
)
week_text <- get_week_range_text(selected_weeks, all_weeks)
if (length(selected_weeks) == 0) {
paste0("Table shows actual and expected fantasy points for ", pos_name, " for ", week_text, ".")
} else if (length(selected_weeks) == 1) {
paste0("Table shows actual and expected fantasy points for ", pos_name, " in ", week_text, " of the 2025 season.")
} else {
paste0("Table shows actual and expected fantasy points for ", pos_name, " during ", week_text, ".")
}
}
library(googlesheets4)
library(tidyverse)
library(janitor)
cat("====================================\n")
cat("XFP DATA UPDATE SCRIPT\n")
cat("Run this weekly to update app data\n")
cat("====================================\n\n")
# Source sheet URL (your main data source)
source_sheet_url <- "https://docs.google.com/spreadsheets/d/1gULbmQ5vmaeoxovra-I1pWP6GlI0tLhqx6NuUCG-uEc/edit?gid=1280900748#gid=1280900748"
# Target PUBLIC sheet URL (where processed data goes)
target_sheet_url <- "https://docs.google.com/spreadsheets/d/1N8Dn8d-3OiqjqATvsz9d79buHBSdz3chjp4wMtd47es/edit?gid=0#gid=0"
# Download source data ====
cat("Step 1: Downloading source data from Google Sheets...\n")
weekly_air_yards <- read_sheet(source_sheet_url, sheet = "WeeklyAirYards") %>%
clean_names()
weekly_rb_xp <- read_sheet(source_sheet_url, sheet = "WeeklyRBXP") %>%
clean_names()
# Process combined_xfp_data ====
cat("Step 2: Processing combined xFP data...\n")
# Process WR/TE/QB data
wr_te_qb_data <- weekly_air_yards %>%
filter(position != "RB") %>%
mutate(
player = receiver,
xFP = ifelse(!is.na(knn_fps), knn_fps, 0),
actual_FP = ppr_points,
carries = 0,
rush_yards = 0,
rush_touchdowns = 0,
goal_line_carry = 0
) %>%
select(
player, position, team, week, season, receiver_id,
xFP, actual_FP,
target, air_yards, rz_target, receptions,
receiving_yards, receiving_touchdowns,
carries, rush_yards, rush_touchdowns, goal_line_carry,
adot, catch_rate, ypt
)
# Process RB data
rb_combined_data <- weekly_rb_xp %>%
mutate(
player = player,
position = "RB",
team = team,
xFP = knn_fps,
actual_FP = actual_fps,
target = targets,
rz_target = NA_real_,
receptions = NA_real_,
receiving_yards = NA_real_,
receiving_touchdowns = NA_real_,
receiver_id = paste0(player, "-", team),
adot = NA_real_,
catch_rate = NA_real_,
ypt = NA_real_
) %>%
select(
player, position, team, week, season, receiver_id,
xFP, actual_FP,
target, air_yards, rz_target, receptions,
receiving_yards, receiving_touchdowns,
carries, rush_yards, rush_touchdowns, goal_line_carry,
adot, catch_rate, ypt
)
# Combine and standardize
combined_xfp_data <- bind_rows(wr_te_qb_data, rb_combined_data) %>%
mutate(
# Standardize team names
team = case_when(
team == "LA" ~ "LAR",
team == "STL" ~ "LAR",
team == "SD" ~ "LAC",
team == "OAK" ~ "LV",
TRUE ~ team
),
# Add calculated fields
xFP = as.numeric(xFP),
actual_FP = as.numeric(actual_FP),
fp_diff = actual_FP - xFP,
games = 1
) %>%
arrange(team, week, desc(xFP))
cat("✓ Combined xFP data processed.\n")
cat("  - Total rows:", nrow(combined_xfp_data), "\n")
cat("  - Unique players:", n_distinct(combined_xfp_data$player), "\n")
cat("  - Weeks included:", paste(sort(unique(combined_xfp_data$week)), collapse = ", "), "\n\n")
# Upload to public Google Sheet ====
cat("Step 3: Uploading processed data to public Google Sheet...\n")
# Clear existing sheet and write new data
sheet_write(
combined_xfp_data,
ss = target_sheet_url,
sheet = "combined_xfp_data"
)
cat("✓ Data successfully uploaded to Google Sheet.\n\n")
# Optional: Save local backup
cat("Step 4: Saving local backup...\n")
dir.create("data", showWarnings = FALSE)
write_csv(combined_xfp_data, "data/combined_xfp_data_backup.csv")
cat("✓ Local backup saved to data/combined_xfp_data_backup.csv\n\n")
# Summary
cat("====================================\n")
cat("UPDATE COMPLETE!\n")
cat("====================================\n")
cat("Processed", nrow(combined_xfp_data), "rows of data\n")
cat("Data is now available at:\n")
cat(target_sheet_url, "\n\n")
cat("Your Shiny app will automatically use this updated data.\n")
cat("No need to redeploy the app!\n")
shiny::runApp()
runApp()
runApp()
runApp()
shiny::runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
